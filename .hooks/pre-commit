#!/bin/bash
# Pre-commit hook for Clusterra Connect
# Auto-formats Terraform files before commit
#
# Install: cp .hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

# Check if tofu or terraform is available
if command -v tofu &> /dev/null; then
    FMT_CMD="tofu fmt"
elif command -v terraform &> /dev/null; then
    FMT_CMD="terraform fmt"
else
    echo "Warning: Neither tofu nor terraform found, skipping format check"
    exit 0
fi

# Get staged .tf files
STAGED_TF_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.tf$')

if [ -n "$STAGED_TF_FILES" ]; then
    echo "Formatting Terraform files..."

    # Format each staged file
    for file in $STAGED_TF_FILES; do
        if [ -f "$file" ]; then
            $FMT_CMD "$file"
            git add "$file"
        fi
    done

    echo "âœ“ Terraform files formatted"
fi

exit 0
